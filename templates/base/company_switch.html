{% extends "base.html" %}
{% load static %}

{% block title %}Switch Company{% endblock %}
{% block page_title %}Switch Company{% endblock %}
{% block header_subtitle %}Select or activate your allowed companies{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto space-y-6">

  <form method="post" class="card bg-base-100 shadow">
    {% csrf_token %}
    <div class="card-body space-y-4">
      <h2 class="card-title text-lg font-bold">Active Companies</h2>

      {% if allowed_companies %}
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Select active companies</span>
          </label>

          <div class="dropdown dropdown-end w-full">
            <label tabindex="0" class="btn btn-outline w-full justify-between">
              <span>
                {% if active_ids %}
                  {{ active_ids|length }} selected
                {% else %}
                  Select companies
                {% endif %}
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 10l5 5 5-5z"/>
              </svg>
            </label>

            <ul tabindex="0"
                class="dropdown-content menu menu-sm p-2 shadow bg-base-100 rounded-box w-full max-h-60 overflow-y-auto">
              {% for c in allowed_companies %}
                <li>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="active_companies"
                           value="{{ c.id }}"
                           class="checkbox checkbox-sm"
                           {% if c.id in active_ids %}checked{% endif %}>
                    <span>{{ c.name }}</span>
                    {% if c.id == current_id %}
                      <span class="badge badge-primary badge-sm ml-1">Current</span>
                    {% endif %}
                  </label>
                </li>
              {% endfor %}
            </ul>
          </div>
          <p class="text-xs text-base-content/70 mt-1">
            At least one company must remain active.
          </p>
        </div>
      {% else %}
        <div class="alert alert-warning">No companies available for your user.</div>
      {% endif %}

      <div class="divider"></div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Current Company</span>
        </label>
        <select name="current_company" class="select select-bordered w-full" required>
          {% for c in allowed_companies %}
            <option value="{{ c.id }}" {% if c.id == current_id %}selected{% endif %}>{{ c.name }}</option>
          {% endfor %}
        </select>
        <p class="text-xs text-base-content/70 mt-1">
          The selected company will be used as your current context.
        </p>
      </div>

      <div class="card-actions justify-end mt-4">
        <a href="{% url 'base:home' %}" class="btn btn-ghost">Cancel</a>
        <button type="submit" class="btn btn-primary">Apply Changes</button>
      </div>
    </div>
  </form>

  {% if current_company %}
    <div class="alert alert-info mt-4">
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
          <path d="M13 16h-1v-4h-1v4H8l4 4 4-4h-3zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48
                   10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8
                   8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
        <span>
          Current active company: <strong>{{ current_company.name }}</strong>
        </span>
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}
