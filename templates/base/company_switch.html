{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}Switch Company · 360 Manager{% endblock %}

{% block content %}
<div class="px-4 py-8 max-w-5xl mx-auto">

  <!-- Breadcrumbs -->
  <nav class="text-sm breadcrumbs mb-5">
    <ul>
      <li><a href="{% url 'base:home' %}">Home</a></li>
      <li>Company</li>
      <li class="font-semibold">Switch</li>
    </ul>
  </nav>

  <!-- Glass card -->
  <div class="rounded-3xl bg-base-100/70 backdrop-blur ring-1 ring-base-300/60 shadow-2xl overflow-hidden">
    <!-- Header -->
    <div class="px-6 pt-6 pb-4 flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">Switch Active Company</h1>
        <p class="text-sm text-base-content/70">
          Choose a company to work under. Lists and forms will be automatically scoped.
        </p>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-xs opacity-70">Current:</span>
        <span class="badge badge-primary badge-outline">
          {{ current_company.name|default:"—" }}
        </span>
      </div>
    </div>

    <!-- Body -->
    <div class="p-6 grid gap-6 lg:grid-cols-3">

      <!-- Pretty list (like Odoo dropdown) -->
      <section class="lg:col-span-2 space-y-4">
        <div class="join w-full">
          <input id="companySearch" type="search" class="input input-bordered join-item w-full rounded-l-2xl"
                 placeholder="Search companies…" />
          <button type="button" class="btn btn-ghost join-item rounded-r-2xl" onclick="document.getElementById('companySearch').value=''; filterCompanies();">
            Clear
          </button>
        </div>

        <div id="companyList"
             class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[22rem] overflow-auto pr-1">
          {% for c in allowed_companies %}
            <button type="button"
                    class="company-item group text-left rounded-2xl p-4 border border-base-300/60 bg-base-100/70 hover:bg-base-200/60 hover:shadow-md transition flex items-start gap-3"
                    data-id="{{ c.id }}" data-name="{{ c.name|lower }}">
              <div class="mt-1">
                <input type="radio" name="company_visual"
                       class="radio radio-primary radio-sm company-radio"
                       {% if current_company and c.id == current_company.id %}checked{% endif %}/>
              </div>
              <div class="min-w-0">
                <div class="font-medium truncate">{{ c.name }}</div>
                <div class="text-xs text-base-content/60 mt-0.5">
                  {% if current_company and c.id == current_company.id %}
                    <span class="badge badge-primary badge-outline">Current</span>
                  {% else %}
                    <span class="badge badge-ghost">Available</span>
                  {% endif %}
                </div>
              </div>
            </button>
          {% empty %}
            <div class="rounded-xl border border-base-300/60 p-4 text-sm text-base-content/70">
              No companies configured for your account.
            </div>
          {% endfor %}
        </div>

        <p class="text-xs text-base-content/60">Tip: Use the search box, or click a card to select. Keyboard: ↑/↓ then Enter.</p>
      </section>

      <!-- Form / fallback select -->
      <aside class="space-y-4">
        {% if messages %}
          <div class="space-y-2">
            {% for message in messages %}
              <div class="alert {{ message.tags|default:'alert-info' }}"><span>{{ message }}</span></div>
            {% endfor %}
          </div>
        {% endif %}

        <form id="switchForm" method="post" class="space-y-4">
          {% csrf_token %}

          <!-- Hidden “real” select that the view expects -->
          <div class="hidden">
            {# keep it in DOM; value is programmatically controlled #}
            {{ form.companies|add_class:"select select-bordered" }}
          </div>

          <div class="rounded-2xl bg-base-200/60 p-4 space-y-2">
            <div class="text-sm font-medium">Selected company</div>
            <div class="text-sm text-base-content/70">
              <span id="selectedCompanyLabel" class="badge badge-outline">
                {% if current_company %}{{ current_company.name }}{% else %}—{% endif %}
              </span>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-2">
            <button type="submit" class="btn btn-primary rounded-xl flex-1">Switch</button>
            <a href="{% url 'base:partner_list' %}" class="btn btn-ghost rounded-xl">Cancel</a>
          </div>

          <div class="divider my-2"></div>

          <div class="rounded-2xl border border-base-300/60 p-4">
            <div class="text-sm font-semibold mb-2">Allowed companies</div>
            <div class="flex flex-wrap gap-2">
              {% for c in allowed_companies %}
                <span class="badge badge-ghost">{{ c.name }}</span>
              {% endfor %}
            </div>
          </div>
        </form>
      </aside>
    </div>
  </div>
</div>

<!-- Minimal JS (no external libs) to mirror pretty list -> hidden select -->
<script>
(function () {
  const list = document.getElementById('companyList');
  const search = document.getElementById('companySearch');
  const selectedLabel = document.getElementById('selectedCompanyLabel');

  // real <select multiple> field rendered by Django form
  const realSelect = document.querySelector('select[name="{{ form.companies.name }}"]');

  // Ensure only one selected value (first value wins) — common pattern in “active company” switchers
  function setSelected(id, name) {
    // clear all options
    for (const opt of realSelect.options) opt.selected = false;
    // select target
    const target = Array.from(realSelect.options).find(o => o.value == id);
    if (target) target.selected = true;
    // update label + radios
    selectedLabel.textContent = name;
    for (const radio of document.querySelectorAll('.company-radio')) radio.checked = false;
    const btn = list.querySelector(`[data-id="${id}"]`);
    if (btn) btn.querySelector('.company-radio').checked = true;
  }

  // Prefill selected from current value in <select>
  (function prefill() {
    const opt = Array.from(realSelect.options).find(o => o.selected);
    if (opt) setSelected(opt.value, opt.textContent.trim());
  })();

  // Click handler on cards
  list?.addEventListener('click', (e) => {
    const btn = e.target.closest('.company-item');
    if (!btn) return;
    setSelected(btn.dataset.id, btn.querySelector('.font-medium').textContent.trim());
  });

  // Filter
  window.filterCompanies = function () {
    const q = (search.value || '').toLowerCase().trim();
    for (const el of list.querySelectorAll('.company-item')) {
      const hit = el.dataset.name.includes(q);
      el.style.display = hit ? '' : 'none';
    }
  };
  search?.addEventListener('input', filterCompanies);

  // Keyboard navigation (↑/↓ + Enter)
  let focusIndex = -1;
  function items() { return Array.from(list.querySelectorAll('.company-item')).filter(el => el.style.display !== 'none'); }
  document.addEventListener('keydown', (e) => {
    const visible = items();
    if (!visible.length) return;
    if (e.key === 'ArrowDown') { e.preventDefault(); focusIndex = (focusIndex + 1) % visible.length; visible[focusIndex].focus(); }
    if (e.key === 'ArrowUp')   { e.preventDefault(); focusIndex = (focusIndex - 1 + visible.length) % visible.length; visible[focusIndex].focus(); }
    if (e.key === 'Enter' && document.activeElement?.classList.contains('company-item')) {
      document.activeElement.click();
    }
  });
})();
</script>
{% endblock %}
