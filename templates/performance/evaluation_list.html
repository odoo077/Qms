{% extends "base.html" %}
{% load performance_permissions %}

{% block title %}Evaluations{% endblock %}
{% block page_title %}Evaluations{% endblock %}
{% block header_title %}Employee Evaluations{% endblock %}
{% block header_subtitle %}
  Browse, filter, and manage employee performance evaluations.
{% endblock %}

{% block page_actions %}
  {% can_add_evaluation user as can_add %}
  {% if can_add %}
    <div class="flex flex-wrap gap-2">
      <a href="{% url 'performance:evaluation_bulk_create' %}" class="btn btn-primary btn-sm">
        Bulk Create
      </a>
      <a href="{% url 'performance:evaluation_create' %}" class="btn btn-outline btn-sm">
        New Evaluation
      </a>
    </div>
  {% endif %}
{% endblock %}

{% block content %}
<div class="card bg-base-100 shadow">
  <div class="card-body space-y-6">

    {# شريط الفلاتر #}
    <form method="get" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

        <div class="form-control">
          <label class="label">
            <span class="label-text">Company</span>
          </label>
          <select name="company" class="select select-sm select-bordered">
            <option value="">All</option>
            {% for c in companies %}
              <option value="{{ c.id }}"
                      {% if current_filters.company == c.id|stringformat:"s" %}selected{% endif %}>
                {{ c.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Employee</span>
          </label>
          <select name="employee" class="select select-sm select-bordered">
            <option value="">All</option>
            {% for e in employees_filter %}
              <option value="{{ e.id }}"
                      {% if current_filters.employee == e.id|stringformat:"s" %}selected{% endif %}>
                {{ e.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Evaluation Type</span>
          </label>
          <select name="type" class="select select-sm select-bordered">
            <option value="">All</option>
            {% for t in evaluation_types_filter %}
              <option value="{{ t.id }}"
                      {% if current_filters.type == t.id|stringformat:"s" %}selected{% endif %}>
                {{ t.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">State</span>
          </label>
          <select name="state" class="select select-sm select-bordered">
            <option value="">All</option>
            {% for value, label in states %}
              <option value="{{ value }}"
                      {% if current_filters.state == value %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="form-control">
          <label class="label">
            <span class="label-text">From (End Date ≥)</span>
          </label>
          <input type="date"
                 name="from_date"
                 value="{{ current_filters.from_date }}"
                 class="input input-sm input-bordered" />
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">To (Start Date ≤)</span>
          </label>
          <input type="date"
                 name="to_date"
                 value="{{ current_filters.to_date }}"
                 class="input input-sm input-bordered" />
        </div>

        <div class="form-control md:col-span-2">
          <label class="label">
            <span class="label-text">Search</span>
          </label>
          <input type="text"
                 name="q"
                 value="{{ current_filters.q }}"
                 placeholder="Search by employee, type, template…"
                 class="input input-sm input-bordered w-full" />
        </div>
      </div>

      <div class="flex items-center justify-between gap-4 text-sm">
        <p class="opacity-70">
          Use filters to narrow down evaluations by company, employee, period, or status.
        </p>
        <div class="space-x-2">
          <a href="{% url 'performance:evaluation_list' %}" class="btn btn-ghost btn-sm">
            Reset
          </a>
          <button type="submit" class="btn btn-primary btn-sm">
            Filter
          </button>
        </div>
      </div>
    </form>

    {# Legend صغيرة للحالات #}
    <div class="flex flex-wrap items-center gap-2 text-xs opacity-80">
      <span class="font-semibold mr-1">States legend:</span>
      <span class="badge badge-ghost badge-sm">Draft</span>
      <span class="badge badge-info badge-sm">Submitted / In Progress</span>
      <span class="badge badge-warning badge-sm">Calibrated</span>
      <span class="badge badge-success badge-sm">Approved</span>
      <span class="badge badge-neutral badge-sm">Locked</span>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra w-full text-sm">
        <thead>
          <tr>
            <th>Evaluation</th>
            <th>Employee</th>
            <th>Type</th>
            <th>Period</th>
            <th>Template</th>
            <th class="text-center">Score</th>
            <th class="text-center">State</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for obj in object_list %}
          <tr>
            <td>
              <div class="flex flex-col">
                <span class="font-semibold">
                  {{ obj.display_name|default:obj }}
                </span>
                <span class="text-xs opacity-70">
                  #{{ obj.id }}
                </span>
              </div>
            </td>

            <td>
              <div class="flex flex-col">
                <span>{{ obj.employee }}</span>
                <span class="text-xs opacity-70">
                  {{ obj.company }}
                </span>
              </div>
            </td>

            <td>
              {% if obj.evaluation_type %}
                <span class="badge badge-outline badge-sm">
                  {{ obj.evaluation_type.name }}
                </span>
              {% else %}
                <span class="text-xs opacity-60">—</span>
              {% endif %}
            </td>

            <td>
              <div class="flex flex-col">
                <span>{{ obj.date_start }} → {{ obj.date_end }}</span>
              </div>
            </td>

            <td>
              {% if obj.template %}
                <span>{{ obj.template }}</span>
              {% else %}
                <span class="text-xs opacity-60">—</span>
              {% endif %}
            </td>

            <td class="text-center">
              {% if obj.final_score_pct %}
                <span class="font-semibold">
                  {{ obj.final_score_pct }}%
                </span>
              {% else %}
                <span class="text-xs opacity-60">—</span>
              {% endif %}
            </td>

            <td class="text-center">
              {% if obj.state == "draft" %}
                <span class="badge badge-ghost badge-sm">Draft</span>
              {% elif obj.state == "submitted" or obj.state == "in_progress" %}
                <span class="badge badge-info badge-sm">In Review</span>
              {% elif obj.state == "calibrated" %}
                <span class="badge badge-warning badge-sm">Calibrated</span>
              {% elif obj.state == "approved" %}
                <span class="badge badge-success badge-sm">Approved</span>
              {% elif obj.state == "locked" %}
                <span class="badge badge-neutral badge-sm">Locked</span>
              {% else %}
                <span class="badge badge-ghost badge-sm">{{ obj.state }}</span>
              {% endif %}
            </td>

            <td class="text-right space-x-1">
              <a href="{% url 'performance:evaluation_detail' obj.id %}"
                 class="btn btn-ghost btn-xs">
                View
              </a>

              {% can_edit_evaluation user obj as can_edit %}
              {% if can_edit %}
                <a href="{% url 'performance:evaluation_update' obj.id %}"
                   class="btn btn-outline btn-xs">
                  Edit
                </a>
              {% endif %}

              {% can_delete_evaluation user obj as can_del %}
              {% if can_del %}
                <a href="{% url 'performance:evaluation_delete' obj.id %}"
                   class="btn btn-error btn-xs">
                  Delete
                </a>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="text-center opacity-70 py-6">
              No evaluations found for the selected filters.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% include "partials/paginator.html" %}

  </div>
</div>
{% endblock %}
