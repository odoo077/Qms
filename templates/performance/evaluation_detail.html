{% extends "base.html" %}
{% load performance_permissions %}

{% block title %}Evaluation Details{% endblock %}
{% block page_title %}Evaluation{% endblock %}
{% block header_title %}Evaluation Details{% endblock %}
{% block header_subtitle %}
  View full evaluation information, workflow status, and scoring breakdown.
{% endblock %}

{% block page_actions %}
  <a href="{% url 'performance:evaluation_list' %}" class="btn btn-sm">
    Back
  </a>

  {% if object %}
    {% if can_submit %}
      <a href="{% url 'performance:evaluation_submit' object.id %}"
         class="btn btn-primary btn-sm">
        Submit
      </a>
    {% endif %}

    {% if can_approve_step %}
      <a href="{% url 'performance:evaluation_approve_step' object.id %}"
         class="btn btn-success btn-sm">
        Approve Step
      </a>
    {% endif %}

    {% if can_reject_step %}
      <a href="{% url 'performance:evaluation_reject_step' object.id %}"
         class="btn btn-warning btn-sm">
        Reject / Send Back
      </a>
    {% endif %}

    {% if can_edit_object %}
      <a href="{% url 'performance:evaluation_update' object.id %}"
         class="btn btn-outline btn-sm">
        Edit
      </a>
    {% endif %}

    {% if can_delete_object %}
      <a href="{% url 'performance:evaluation_delete' object.id %}"
         class="btn btn-error btn-sm">
        Delete
      </a>
    {% endif %}
  {% endif %}
{% endblock %}

{% block content %}
<div class="space-y-6">

  {# ============== Summary Card ============== #}
  <div class="card bg-base-100 shadow">
    <div class="card-body space-y-4">

      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold">
            {{ object.employee }}
          </h2>
          <p class="text-sm opacity-70">
            Evaluation #{{ object.id }}
            {% if object.evaluation_type %}
              • {{ object.evaluation_type.name }}
            {% endif %}
          </p>
        </div>

        <div class="flex flex-wrap gap-2 items-center">
          {% if object.state == "draft" %}
            <span class="badge badge-ghost">Draft</span>
          {% elif object.state == "submitted" or object.state == "in_progress" %}
            <span class="badge badge-info">In Review</span>
          {% elif object.state == "calibrated" %}
            <span class="badge badge-warning">Calibrated</span>
          {% elif object.state == "approved" %}
            <span class="badge badge-success">Approved</span>
          {% elif object.state == "locked" %}
            <span class="badge badge-neutral">Locked</span>
          {% else %}
            <span class="badge badge-ghost">{{ object.state }}</span>
          {% endif %}

          {% if object.active %}
            <span class="badge badge-outline badge-success">Active</span>
          {% else %}
            <span class="badge badge-outline badge-ghost">Inactive</span>
          {% endif %}
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
        <div class="stat bg-base-200 rounded-box">
          <div class="stat-title text-xs uppercase opacity-70">Period</div>
          <div class="stat-value text-base">
            {{ object.date_start }} → {{ object.date_end }}
          </div>
          <div class="stat-desc text-xs opacity-70">
            Evaluation window
          </div>
        </div>

        <div class="stat bg-base-200 rounded-box">
          <div class="stat-title text-xs uppercase opacity-70">Final Score</div>
          <div class="stat-value text-base">
            {{ object.final_score_pct }}%
          </div>
          <div class="stat-desc text-xs opacity-70">
            Weighted overall result
          </div>
        </div>

        <div class="stat bg-base-200 rounded-box">
          <div class="stat-title text-xs uppercase opacity-70">Evaluation Type</div>
          <div class="stat-value text-base">
            {% if object.evaluation_type %}
              {{ object.evaluation_type.name }}
            {% else %}
              <span class="opacity-60">—</span>
            {% endif %}
          </div>
          <div class="stat-desc text-xs opacity-70">
            Monthly, quarterly, etc.
          </div>
        </div>

        <div class="stat bg-base-200 rounded-box">
          <div class="stat-title text-xs uppercase opacity-70">Current Approver</div>
          <div class="stat-value text-base">
            {% if object.current_approver %}
              {{ object.current_approver }}
            {% elif object.state == "approved" or object.state == "locked" %}
              <span class="opacity-70">Completed</span>
            {% else %}
              <span class="opacity-60">—</span>
            {% endif %}
          </div>
          <div class="stat-desc text-xs opacity-70">
            Step {{ current_step|default:0 }} in workflow
          </div>
        </div>
      </div>

    </div>
  </div>

  {# ============== Basic Info + Template ============== #}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 space-y-6">

      <div class="card bg-base-100 shadow">
        <div class="card-body space-y-4">
          <h2 class="text-sm font-semibold tracking-wide uppercase opacity-70">
            Core Information
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <h3 class="font-semibold mb-1">Company</h3>
              <p>{{ object.company }}</p>
            </div>

            <div>
              <h3 class="font-semibold mb-1">Employee</h3>
              <p>{{ object.employee }}</p>
            </div>

            <div>
              <h3 class="font-semibold mb-1">Evaluator</h3>
              <p>
                {% if object.evaluator %}
                  {{ object.evaluator }}
                {% else %}
                  <span class="opacity-60">—</span>
                {% endif %}
              </p>
            </div>

            <div>
              <h3 class="font-semibold mb-1">Template</h3>
              <p>
                {% if object.template %}
                  {{ object.template }}
                {% else %}
                  <span class="opacity-60">—</span>
                {% endif %}
              </p>
            </div>

            <div>
              <h3 class="font-semibold mb-1">Overall Rating</h3>
              <p>
                {% if object.overall_rating %}
                  {{ object.overall_rating }}
                {% else %}
                  <span class="opacity-60">—</span>
                {% endif %}
              </p>
            </div>

            <div>
              <h3 class="font-semibold mb-1">State</h3>
              <p>{{ object.state }}</p>
            </div>
          </div>

          {% if object.calibration_notes %}
            <div class="mt-4">
              <h3 class="font-semibold mb-1">Calibration / Manager Notes</h3>
              <div class="p-3 rounded-box bg-base-200 text-sm whitespace-pre-line">
                {{ object.calibration_notes }}
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      {# ============== Parameter Results ============== #}
      <div class="card bg-base-100 shadow">
        <div class="card-body space-y-4">
          <h2 class="text-sm font-semibold tracking-wide uppercase opacity-70">
            Scoring Breakdown
          </h2>

          <div class="overflow-x-auto">
            <table class="table table-zebra w-full text-xs md:text-sm">
              <thead>
                <tr>
                  <th>Parameter</th>
                  <th>Objective / KPI</th>
                  <th>Source</th>
                  <th class="text-center">Weight</th>
                  <th class="text-center">Score %</th>
                  <th>Raw Value</th>
                </tr>
              </thead>
              <tbody>
                {% for res in object.parameter_results.all %}
                  {% with p=res.parameter %}
                  <tr>
                    <td>
                      <div class="flex flex-col">
                        <span class="font-semibold">{{ p.name }}</span>
                        {% if p.code %}
                          <span class="text-[11px] opacity-70">Code: {{ p.code }}</span>
                        {% endif %}
                      </div>
                    </td>
                    <td>
                      <div class="flex flex-col">
                        {% if p.objective %}
                          <span>{{ p.objective }}</span>
                        {% endif %}
                        {% if p.kpi %}
                          <span class="text-[11px] opacity-70">KPI: {{ p.kpi }}</span>
                        {% endif %}
                        {% if not p.objective and not p.kpi %}
                          <span class="opacity-60">—</span>
                        {% endif %}
                      </div>
                    </td>
                    <td>
                      <span class="badge badge-ghost badge-sm">
                        {{ p.get_source_kind_display }}
                      </span>
                    </td>
                    <td class="text-center">
                      {{ p.weight_pct }}%
                    </td>
                    <td class="text-center">
                      {{ res.score_pct }}%
                    </td>
                    <td>
                      {% if res.raw_value_number %}
                        {{ res.raw_value_number }}
                      {% elif res.raw_value_json %}
                        <span class="text-[11px] opacity-70">
                          JSON
                        </span>
                      {% else %}
                        <span class="opacity-60">—</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endwith %}
                {% empty %}
                  <tr>
                    <td colspan="6" class="text-center opacity-70 py-4">
                      No parameter results available for this evaluation.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
      </div>

    </div>

    {# ============== Workflow & Audit Side Panel ============== #}
    <div class="space-y-6">

      {# Workflow Steps #}
      <div class="card bg-base-100 shadow">
        <div class="card-body space-y-4">
          <h2 class="text-sm font-semibold tracking-wide uppercase opacity-70">
            Approval Workflow
          </h2>

          {% if workflow_steps %}
            <div class="overflow-x-auto">
              <table class="table table-sm w-full">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Step</th>
                    <th>Approver Type</th>
                    <th>Configured Approver</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for step in workflow_steps %}
                    {% with idx=forloop.counter %}
                    <tr
                      {% if object.state == "approved" or object.state == "locked" %}
                        class="bg-base-200"
                      {% elif idx == current_step %}
                        class="bg-base-200"
                      {% endif %}
                    >
                      <td>{{ idx }}</td>
                      <td>{{ step.name }}</td>
                      <td>
                        <span class="badge badge-outline badge-xs">
                          {{ step.get_approver_kind_display }}
                        </span>
                      </td>
                      <td>
                        {% if step.approver_kind == step.ApproverKind.EMPLOYEE and step.approver_employee %}
                          {{ step.approver_employee }}
                        {% elif step.approver_kind == step.ApproverKind.GROUP and step.approver_group %}
                          Group: {{ step.approver_group.name }}
                        {% elif step.approver_kind == step.ApproverKind.DIRECT_MANAGER %}
                          Direct Manager
                        {% elif step.approver_kind == step.ApproverKind.DEPARTMENT_MANAGER %}
                          Department Manager
                        {% elif step.approver_kind == step.ApproverKind.MANAGER_CHAIN %}
                          Manager chain (level {{ step.manager_level }})
                        {% else %}
                          <span class="opacity-60">—</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if object.state == "approved" or object.state == "locked" %}
                          <span class="badge badge-success badge-xs">Completed</span>
                        {% else %}
                          {% if current_step|default:0 == 0 %}
                            <span class="badge badge-ghost badge-xs">Pending</span>
                          {% else %}
                            {% if idx < current_step %}
                              <span class="badge badge-success badge-xs">Completed</span>
                            {% elif idx == current_step and object.state == "in_progress" %}
                              <span class="badge badge-info badge-xs">Current</span>
                            {% else %}
                              <span class="badge badge-ghost badge-xs">Pending</span>
                            {% endif %}
                          {% endif %}
                        {% endif %}
                      </td>
                    </tr>
                    {% endwith %}
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-sm opacity-70">
              No workflow steps configured for this evaluation type.
            </p>
          {% endif %}

          <div class="text-xs opacity-70 mt-2">
            Workflow is driven by the Evaluation Type and its approval steps.
          </div>
        </div>
      </div>

      {# Audit Info #}
      <div class="card bg-base-100 shadow">
        <div class="card-body space-y-4">
          <h2 class="text-sm font-semibold tracking-wide uppercase opacity-70">
            Audit & Timeline
          </h2>

          <div class="space-y-2 text-sm">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <h3 class="font-semibold mb-1">Created At</h3>
                <p>{{ object.created_at }}</p>
              </div>
              <div>
                <h3 class="font-semibold mb-1">Updated At</h3>
                <p>{{ object.updated_at }}</p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <h3 class="font-semibold mb-1">Submitted</h3>
                <p>
                  {% if object.submitted_at %}
                    {{ object.submitted_at }}{% if object.submitted_by %} – {{ object.submitted_by }}{% endif %}
                  {% else %}
                    <span class="opacity-60">Not submitted</span>
                  {% endif %}
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-1">Calibrated</h3>
                <p>
                  {% if object.calibrated_at %}
                    {{ object.calibrated_at }}{% if object.calibrated_by %} – {{ object.calibrated_by }}{% endif %}
                  {% else %}
                    <span class="opacity-60">Not calibrated</span>
                  {% endif %}
                </p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <h3 class="font-semibold mb-1">Approved</h3>
                <p>
                  {% if object.approved_at %}
                    {{ object.approved_at }}{% if object.approved_by %} – {{ object.approved_by }}{% endif %}
                  {% else %}
                    <span class="opacity-60">Not approved</span>
                  {% endif %}
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-1">Locked</h3>
                <p>
                  {% if object.locked_at %}
                    {{ object.locked_at }}
                  {% else %}
                    <span class="opacity-60">Not locked</span>
                  {% endif %}
                </p>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

</div>
{% endblock %}
