{% load static %}
<!doctype html>
<html lang="en" dir="ltr" class="no-transitions" data-theme="{{ request.COOKIES.theme|default:'corporate' }}">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}360 Manager{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />

  {# Early theme hydrate: set on <html> AND <body> before CSS loads #}
  <script>
    (function () {
      var html = document.documentElement;
      function getCookie(name){
        var m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]+)'));
        return m ? decodeURIComponent(m[1]) : null;
      }
      var t = getCookie("theme") || localStorage.getItem("theme") || html.getAttribute("data-theme") || "corporate";
      html.setAttribute("data-theme", t);
      // we’ll also mirror it to <body> as soon as it exists
      document.addEventListener("DOMContentLoaded", function(){
        document.body && document.body.setAttribute("data-theme", t);
      });
    })();
  </script>

  <link href="{% static 'css/dist/styles.css' %}" rel="stylesheet" />
  <link rel="icon" href="{% static 'images/favicon.ico' %}" />

  <style>
    .no-transitions *, .no-transitions *::before, .no-transitions *::after { transition: none !important; animation: none !important; }
    html[data-theme="corporate"], body[data-theme="corporate"] { background:#f6f7fb; }
    html[data-theme="business"],  body[data-theme="business"]  { background:#0b1220; }
    body { min-height: 100vh; }
  </style>

  {% block head_extra %}{% endblock %}
</head>
<body class="bg-base-200 text-base-content min-h-screen selection:bg-primary/20 selection:text-primary" data-theme="{{ request.COOKIES.theme|default:'corporate' }}">

<!-- ================= Drawer Layout ================= -->
<div class="drawer">
  <input id="app-drawer" type="checkbox" class="drawer-toggle" />
  <div class="drawer-content flex min-h-screen flex-col">

    <!-- Navbar -->
    <header class="navbar bg-base-100/80 backdrop-blur border-b border-base-200 sticky top-0 z-50">
      <div class="w-full max-w-7xl mx-auto px-4 sm:px-6">
        <div class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <label for="app-drawer" class="btn btn-ghost btn-square" aria-label="Open menu">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z"/>
              </svg>
            </label>
            <a href="{% url 'base:home' %}" class="btn btn-ghost px-0 text-xl font-extrabold tracking-tight">
              <span class="text-primary">360</span><span class="text-error">Manager</span>
            </a>
          </div>

          <div class="flex items-center gap-2">
            {% if current_company %}
              <a href="{% url 'base:company_switch' %}" class="btn btn-outline btn-xs sm:btn-sm gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 7h18v2H3zm0 4h12v2H3zm0 4h18v2H3z"/></svg>
                {{ current_company.name }}
              </a>
            {% endif %}

            <!-- EXACT same IDs as auth_base.html -->
            <button id="theme-toggle" class="btn btn-ghost btn-sm" type="button" aria-label="Toggle theme">
              <svg id="icon-sun" xmlns="http://www.w3.org/2000/svg" class="size-5 hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84 5.34 3.42 3.92 4.84l1.42 1.42 1.42-1.42Zm10.48 14.32 1.42 1.42 1.42-1.42-1.42-1.42-1.42 1.42ZM12 5a1 1 0 0 0 1-1V2h-2v2a1 1 0 0 0 1 1Zm0 14a1 1 0 0 0-1 1v2h2v-2a1 1 0 0 0-1-1ZM5 12a1 1 0 0 0-1-1H2v2h2a1 1 0 0 0 1-1Zm17-1h-2a1 1 0 1 0 0 2h2v-2Zm-3.34-6.58L17.24 4.84l1.42 1.42 1.42-1.42-1.42-1.42ZM4.84 17.24 3.42 18.66l1.42 1.42 1.42-1.42-1.42-1.42ZM12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10Z"/></svg>
              <svg id="icon-moon" xmlns="http://www.w3.org/2000/svg" class="size-5" viewBox="0 0 24 24" fill="currentColor"><path d="M11.38 2.02a1 1 0 0 0-1.23 1.2A9 9 0 1 0 20.78 5.7a1 1 0 0 0-1.21-1.22A7 7 0 0 1 11.38 2.02Z"/></svg>
            </button>

            {% if user.is_authenticated %}
              <div class="hidden md:block text-sm text-base-content/70 mr-1">
                Hi, {{ user.name|default:user.email }}
              </div>
              <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-ghost btn-circle avatar">
                  <div class="w-9 rounded-full">
                    <img src="https://api.dicebear.com/8.x/initials/svg?seed={{ user.name|default:user.email }}" alt="avatar"/>
                  </div>
                </label>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-48">
                  <li><a href="{% url 'base:profile' %}">Profile</a></li>
                  <li><a href="{% url 'base:edit_profile' %}">Edit profile</a></li>
                  <li><a href="{% url 'base:password_change' %}">Change password</a></li>
                  <li><a href="{% url 'base:logout' %}" class="text-error">Logout</a></li>
                </ul>
              </div>
            {% else %}
              <a href="{% url 'base:login' %}?next={{ request.path|urlencode }}" class="btn btn-primary btn-sm">Login</a>
            {% endif %}
          </div>
        </div>
      </div>
    </header>

    <!-- Page header -->
    <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 py-6">
      {% block breadcrumbs %}
      <div class="breadcrumbs text-sm">
        <ul>
          <li><a href="{% url 'base:home' %}">Home</a></li>
          <li>{% block page_title %}{% endblock %}</li>
        </ul>
      </div>
      {% endblock %}

      <div class="mt-2 flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
        <div>
          <h1 class="text-2xl sm:text-3xl font-bold leading-tight">
            {% block header_title %}{% block page_title_fallback %}{% endblock %}{% endblock %}
          </h1>
          <p class="mt-1 text-sm text-base-content/70">{% block header_subtitle %}{% endblock %}</p>
        </div>
        <div class="flex gap-2">{% block page_actions %}{% endblock %}</div>
      </div>
    </div>

    {% if messages %}
      <div class="w-full max-w-7xl mx-auto px-4 sm:px-6">
        <div class="space-y-2">
          {% for message in messages %}
            <div class="alert {% if 'error' in message.tags %}alert-error{% elif 'success' in message.tags %}alert-success{% elif 'warning' in message.tags %}alert-warning{% else %}alert-info{% endif %}">
              <span>{{ message }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Main -->
    <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 py-6">
      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-base-100 border-t mt-10">
      <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 py-6 flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between text-sm text-base-content/70">
        <div>© {% now "Y" %} 360 Manager — All rights reserved.</div>
        <div class="flex flex-wrap items-center gap-3">
          <a class="link link-hover">Privacy</a>
          <span class="opacity-40">•</span>
          <a class="link link-hover">Terms</a>
          <span class="opacity-40">•</span>
          <span class="opacity-70">v{{ APP_VERSION|default:"1.0" }}</span>
        </div>
      </div>
    </footer>
  </div>

  <!-- Drawer side (30% width) -->
  <aside class="drawer-side z-40">
    <label for="app-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
    <div class="bg-base-100 border-r h-full w-[30vw] min-w-72 max-w-xl">
      <div class="px-4 py-4 border-b flex items-center justify-between">
        <a href="{% url 'base:home' %}" class="font-extrabold text-lg">
          <span class="text-primary">360</span> <span class="text-error">Manager</span>
        </a>
        <label for="app-drawer" class="btn btn-ghost btn-square" aria-label="Close menu">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18L18 6M6 6l12 12"/></svg>
        </label>
      </div>

      <div class="px-3 py-3 space-y-2 overflow-y-auto h-[calc(100vh-4rem)]">
        <div class="collapse collapse-arrow bg-base-200">
          <input type="checkbox" />
          <div class="collapse-title font-semibold">General</div>
          <div class="collapse-content">
            <ul class="menu p-0">
              <li><a href="{% url 'base:partner_list' %}">Partners</a></li>
              <li><a href="{% url 'base:company_switch' %}">Switch company</a></li>
              {% if not user.is_authenticated %}
                <li><a href="{% url 'base:login' %}?next={{ request.path|urlencode }}">Login</a></li>
                <li><a href="{% url 'base:register' %}">Create account</a></li>
              {% endif %}
            </ul>
          </div>
        </div>

        {% if user.is_authenticated %}
        <div class="collapse collapse-arrow bg-base-200">
          <input type="checkbox" />
          <div class="collapse-title font-semibold">HR</div>
          <div class="collapse-content">
            <ul class="menu p-0">
              <li><a href="{% url 'hr:employee_list' %}">Employees</a></li>
              <li><a href="{% url 'hr:department_list' %}">Departments</a></li>
              <li><a href="{% url 'hr:job_list' %}">Jobs</a></li>
              <li><a href="{% url 'hr:work_location_list' %}">Work locations</a></li>
              <li class="menu-title"><span>Config</span></li>
              <li><a href="{% url 'hr:category_list' %}">Employee categories</a></li>
              <li><a href="{% url 'hr:contract_type_list' %}">Contract types</a></li>
            </ul>
          </div>
        </div>

        <div class="collapse collapse-arrow bg-base-200">
          <input type="checkbox" />
          <div class="collapse-title font-semibold">Skills</div>
          <div class="collapse-content">
            <ul class="menu p-0">
              <li><a href="{% url 'skills:skill_type_list' %}">Skill types</a></li>
              <li><a href="{% url 'skills:skill_level_list' %}">Skill levels</a></li>
              <li><a href="{% url 'skills:skill_list' %}">Skills</a></li>
              <li class="menu-title"><span>Employees</span></li>
              <li><a href="{% url 'skills:employee_skill_list' %}">Employee skills</a></li>
              <li class="menu-title"><span>Resume</span></li>
              <li><a href="{% url 'skills:resume_line_list' %}">Resume lines</a></li>
              <li><a href="{% url 'skills:resume_line_type_list' %}">Resume line types</a></li>
            </ul>
          </div>
        </div>

        <div class="collapse collapse-arrow bg-base-200">
          <input type="checkbox" />
          <div class="collapse-title font-semibold">Assets</div>
          <div class="collapse-content">
            <ul class="menu p-0">
              <li><a href="{% url 'assets:asset_type_list' %}">Asset types</a></li>
              <li><a href="{% url 'assets:asset_model_list' %}">Asset models</a></li>
              <li><a href="{% url 'assets:asset_item_list' %}">Asset items</a></li>
              <li class="menu-title"><span>Assignments</span></li>
              <li><a href="{% url 'assets:employee_asset_list' %}">Employee assets</a></li>
              <li><a href="{% url 'assets:employee_asset_assign' %}">Assign asset</a></li>
            </ul>
          </div>
        </div>

  <!-- Performance -->
<div class="collapse collapse-arrow bg-base-200">
  <input type="checkbox" />
  <div class="collapse-title font-semibold">Performance</div>
  <div class="collapse-content">
    <ul class="menu p-0">
      <!-- أهداف -->
      <li><a href="{% url 'performance:objective_list' %}">Objectives</a></li>

      <!-- مؤشرات KPI -->
      <li><a href="{% url 'performance:kpi_list' %}">KPIs</a></li>

      <!-- مهام مرتبطة بالأهداف/KPI -->
      <li><a href="{% url 'performance:task_list' %}">Tasks</a></li>

      <!-- التقييمات -->
      <li class="menu-title"><span>Evaluations</span></li>
      <li><a href="{% url 'performance:evaluation_list' %}">Evaluations</a></li>
      <li><a href="{% url 'performance:evaluation_template_list' %}">Templates</a></li>
      <li><a href="{% url 'performance:evaluation_parameter_list' %}">Parameters</a></li>
    </ul>
  </div>
</div>


        <div class="collapse collapse-arrow bg-base-200">
          <input type="checkbox" />
          <div class="collapse-title font-semibold">Account</div>
          <div class="collapse-content">
            <ul class="menu p-0">
              <li><a href="{% url 'base:profile' %}">Profile</a></li>
              <li><a href="{% url 'base:edit_profile' %}">Edit profile</a></li>
              <li><a href="{% url 'base:password_change' %}">Change password</a></li>
              <li><a href="{% url 'base:logout' %}" class="text-error">Logout</a></li>
            </ul>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </aside>
</div>

<!-- Theme switcher: update <html> + <body> -->
<script>
  (function () {
    const html = document.documentElement;
    const btn  = document.getElementById("theme-toggle");
    const sun  = document.getElementById("icon-sun");
    const moon = document.getElementById("icon-moon");
    const DARK = new Set(["business","dark","forest","black"]);

    function getCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]+)'));
      return m ? decodeURIComponent(m[1]) : null;
    }
    function setCookie(name,value,days){
      const max = days ? `; max-age=${days*86400}` : "";
      document.cookie = `${name}=${encodeURIComponent(value)}; path=/${max}`;
    }
    function setTheme(t){
      html.setAttribute("data-theme", t);
      if (document.body) document.body.setAttribute("data-theme", t);
      localStorage.setItem("theme", t);
      setCookie("theme", t, 365);
      const isDark = DARK.has(t);
      if (sun && moon) {
        sun.classList.toggle("hidden", !isDark);
        moon.classList.toggle("hidden", isDark);
      }
    }

    const initial = getCookie("theme") || localStorage.getItem("theme") || html.getAttribute("data-theme") || "corporate";
    setTheme(initial);

    btn?.addEventListener("click", () => {
      const now  = html.getAttribute("data-theme") || "corporate";
      const next = (now === "corporate") ? "business" : "corporate";
      setTheme(next);
    });

    window.addEventListener("DOMContentLoaded", () => html.classList.remove("no-transitions"));
  })();
</script>

{% block extra_scripts %}{% endblock %}
</body>
</html>
