{% load static %}

<html lang="en" class="no-transitions" data-theme="{{ request.COOKIES.theme|default:'corporate' }}">
<head>
  <meta charset="utf-8" />
  <title>{% block title %}360 Manager{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />

  <!-- Prevent flash before CSS loads -->
  <style>
    .no-transitions *, .no-transitions *::before, .no-transitions *::after {
      transition: none !important; animation: none !important;
    }
    html[data-theme="corporate"] { background:#f3f4f6; color:#111827; }
    html[data-theme="business"]  { background:#0b1220; color:#e5e7eb; }
    body { min-height:100vh; }
  </style>

  <!-- Tailwind / DaisyUI build -->
  <link href="{% static 'css/dist/styles.css' %}" rel="stylesheet">
  <link rel="icon" href="{% static 'images/favicon.ico' %}">
</head>
<body class="bg-base-200 text-base-content flex flex-col">

<!-- Top Navbar -->
<nav class="navbar bg-base-100 shadow-md sticky top-0 z-40">
  <div class="container mx-auto px-4 md:px-6 flex items-center justify-between">

    <!-- Brand + primary nav -->
    <div class="flex items-center gap-6">
      <a href="{% url 'base:home' %}" class="flex items-center gap-2 font-bold text-xl">
        <svg width="28" height="28" viewBox="0 0 32 32" fill="none">
          <circle cx="16" cy="16" r="12" stroke="#2563eb" stroke-width="2.5"></circle>
          <circle cx="8"  cy="16" r="2"  fill="#ef4444"></circle>
          <circle cx="24" cy="16" r="2"  fill="#facc15"></circle>
          <circle cx="16" cy="8"  r="2"  fill="#2563eb"></circle>
        </svg>
        <span><span class="text-primary">360</span><span class="text-error">Manager</span></span>
      </a>

      {% if user.is_authenticated %}
      <!-- Primary links (desktop) -->
      <div class="flex items-center gap-4">
        <a href="{% url 'base:partner_list' %}" class="px-2 py-1 font-semibold text-base-content/70 hover:text-primary">
          Partners
        </a>
        <a href="{% url 'base:company_switch' %}" class="px-2 py-1 font-semibold text-base-content/70 hover:text-primary">
          Switch Company
        </a>

        <!-- HR dropdown -->
        <div class="dropdown">
          <div tabindex="0" role="button" class="px-2 py-1 font-semibold text-base-content/70 hover:text-primary flex items-center gap-1">
            HR
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
            </svg>
          </div>
          <ul tabindex="0" class="menu dropdown-content bg-base-100 rounded-box z-[1] w-64 p-2 shadow">
            <li class="{% if request.path|slice:':4' == '/hr' and 'employees' in request.path %}bg-base-200{% endif %}">
              <a href="{% url 'hr:employee_list' %}">Employees</a>
            </li>
            <li class="{% if request.path|slice:':4' == '/hr' and 'departments' in request.path %}bg-base-200{% endif %}">
              <a href="{% url 'hr:department_list' %}">Departments</a>
            </li>
            <li class="{% if request.path|slice:':4' == '/hr' and 'jobs' in request.path %}bg-base-200{% endif %}">
              <a href="{% url 'hr:job_list' %}">Jobs</a>
            </li>
            <li class="{% if request.path|slice:':4' == '/hr' and 'work-locations' in request.path %}bg-base-200{% endif %}">
              <a href="{% url 'hr:work_location_list' %}">Work locations</a>
            </li>
            <li class="menu-title"><span>Config</span></li>
            <li class="{% if request.path|slice:':4' == '/hr' and 'categories' in request.path %}bg-base-200{% endif %}">
              <a href="{% url 'hr:category_list' %}">Employee categories</a>
            </li>
            <li class="{% if request.path|slice:':4' == '/hr' and 'contract-types' in request.path %}bg-base-200{% endif %}">
              <a href="{% url 'hr:contract_type_list' %}">Contract types</a>
            </li>
          </ul>
        </div>
        <!-- /HR dropdown -->

        <!-- Skills dropdown -->
        <div class="dropdown">
          <div tabindex="0" role="button" class="px-2 py-1 font-semibold text-base-content/70 hover:text-primary flex items-center gap-1">
            Skills
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />
            </svg>
          </div>
          <ul tabindex="0" class="menu dropdown-content bg-base-100 rounded-box z-[1] w-72 p-2 shadow">
            <!-- Skill Types -->
            <li class="{% if request.path|slice:':20' == '/skills/skill-types/' %}bg-base-200{% endif %}">
              <a href="{% url 'skills:skill_type_list' %}">Skill types</a>
            </li>

            <!-- Skill Levels -->
            <li class="{% if request.path|slice:':21' == '/skills/skill-levels/' %}bg-base-200{% endif %}">
              <a href="{% url 'skills:skill_level_list' %}">Skill levels</a>
            </li>

            <!-- Skills (الكيان نفسه) -->
            <li class="{% if request.path|slice:':15' == '/skills/skills/' %}bg-base-200{% endif %}">
              <a href="{% url 'skills:skill_list' %}">Skills</a>
            </li>

            <li class="menu-title"><span>Employees</span></li>

            <!-- Employee Skills -->
            <li class="{% if request.path|slice:':24' == '/skills/employee-skills/' %}bg-base-200{% endif %}">
              <a href="{% url 'skills:employee_skill_list' %}">Employee skills</a>
            </li>

            <li class="menu-title"><span>Resume</span></li>

            <!-- Resume Lines -->
            <li class="{% if request.path|slice:':21' == '/skills/resume-lines/' %}bg-base-200{% endif %}">
              <a href="{% url 'skills:resume_line_list' %}">Resume lines</a>
            </li>

            <!-- Resume Line Types -->
            <li class="{% if request.path|slice:':26' == '/skills/resume-line-types/' %}bg-base-200{% endif %}">
              <a href="{% url 'skills:resume_line_type_list' %}">Resume line types</a>
            </li>
          </ul>
        </div>
        <!-- /Skills dropdown -->


      </div>
      {% endif %}
    </div>

    <!-- Right side: company badge + theme + user -->
    <div class="flex items-center gap-3">
      {% if current_company %}
        <a href="{% url 'base:company_switch' %}" class="btn btn-xs md:btn-sm btn-outline gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 md:w-5 md:h-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 7h18v2H3zm0 4h12v2H3zm0 4h18v2H3z"/>
          </svg>
          {{ current_company.name }}
        </a>
      {% else %}
        <a href="{% url 'base:company_switch' %}" class="btn btn-xs md:btn-sm btn-outline">Select company</a>
      {% endif %}

      <!-- Theme toggle -->
      <button id="theme-toggle" class="btn btn-circle btn-ghost btn-sm" title="Toggle Theme">
        <svg id="theme-sun" class="hidden w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 18a6 6 0 100-12 6 6 0 000 12z"/>
          <path d="M12 2v2m0 16v2m10-10h-2M4 12H2m16.95 6.95l-1.41-1.41M6.46 6.46L5.05 5.05m13.9 0l-1.41 1.41M6.46 17.54l-1.41 1.41"/>
        </svg>
        <svg id="theme-moon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
        </svg>
      </button>

      {% if user.is_authenticated %}
        <span class="hidden md:inline text-sm text-base-content/70">
          Hi, {{ user.name|default:user.email }}
        </span>

        <!-- User dropdown -->
        <div class="dropdown dropdown-end">
          <label tabindex="0" class="btn btn-ghost btn-circle avatar">
            <div class="w-9 rounded-full">
              <img src="https://api.dicebear.com/8.x/initials/svg?seed={{ user.name|default:user.email }}" alt="avatar" />
            </div>
          </label>
          <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-48">
            <li><a href="{% url 'base:profile' %}">Profile</a></li>
            <li><a href="{% url 'base:edit_profile' %}">Edit profile</a></li>
            <li><a href="{% url 'base:password_change' %}">Change password</a></li>
            <li><a href="{% url 'base:logout' %}" class="text-error">Logout</a></li>
          </ul>
        </div>
      {% else %}
        <a href="{% url 'base:login' %}?next={{ request.path|urlencode }}" class="btn btn-primary btn-sm">Login</a>
      {% endif %}
    </div>
    <!-- /Right side -->
  </div>
</nav>


<!-- أي نجاح/تحذير/خطأ يظهر أعلى الصفحة بعد أي عملية (حفظ/تحويل شركة…). -->
{% if messages %}
  <div class="container mx-auto px-4 md:px-6 mt-4 space-y-2">
    {% for message in messages %}
      <div class="alert {{ message.tags|default:'alert-info' }}">
        <span>{{ message }}</span>
      </div>
    {% endfor %}
  </div>
{% endif %}


<!-- Main -->
<main class="flex-grow container mx-auto px-4 md:px-6 py-6">
  {% block content %}{% endblock %}
</main>

<!-- Footer -->
<footer class="bg-base-100 border-t mt-12 py-6 text-center text-sm text-base-content/70">
  &copy; {% now "Y" %} 360 Manager · All rights reserved.
</footer>

<!-- Theme toggle logic -->
<script>
  (function() {
    const html = document.documentElement;
    const btn  = document.getElementById("theme-toggle");
    const sun  = document.getElementById("theme-sun");
    const moon = document.getElementById("theme-moon");
    const DARK = new Set(["business"]);
    function setCookie(name, value, days){
      const maxAge = days ? `; max-age=${days*24*60*60}` : "";
      document.cookie = `${name}=${encodeURIComponent(value)}; path=/${maxAge}`;
    }
    function applyIcons(theme){
      const isDark = DARK.has(theme);
      if (isDark) { sun.classList.remove("hidden"); moon.classList.add("hidden"); }
      else        { sun.classList.add("hidden");  moon.classList.remove("hidden"); }
    }
    // initial
    let theme = html.getAttribute("data-theme") || (document.cookie.match(/(?:^|; )theme=([^;]+)/)||[])[1];
    theme = theme ? decodeURIComponent(theme) : (localStorage.getItem("theme") || "corporate");
    html.setAttribute("data-theme", theme);
    applyIcons(theme);

    btn?.addEventListener("click", () => {
      const now  = html.getAttribute("data-theme") || "corporate";
      const next = (now === "business") ? "corporate" : "business";
      html.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
      setCookie("theme", next, 365);
      applyIcons(next);
    });

    // remove transition lock after paint
    window.addEventListener("DOMContentLoaded", () => {
      document.documentElement.classList.remove("no-transitions");
    });
  })();
</script>

</body>
</html>
