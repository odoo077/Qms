{% extends "base.html" %}

{% block title %}
{{ employee.name }} · Employee
{% endblock %}

{% block content %}
<div class=" mx-auto px-6 py-6 space-y-6">

    <!-- ===================================================== -->
    <!-- Header -->
    <!-- ===================================================== -->
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold flex items-center gap-2">
                {{ employee.name }}

                {% if employee.current_status %}
                    <span class="badge
                        {% if employee.current_status.is_active_flag %}
                            badge-success
                        {% elif employee.current_status.code == 'suspended' %}
                            badge-warning
                        {% else %}
                            badge-error
                        {% endif %}
                    ">
                        {{ employee.current_status.name }}
                    </span>
                {% endif %}
            </h1>

            <p class="text-sm opacity-70 mt-1">
                {{ employee.job.name|default:"No job title" }}
                {% if employee.department %}
                    · {{ employee.department.complete_name }}
                {% endif %}
            </p>
        </div>

        <div class="flex gap-2">
          <a href="{{ employee.get_edit_url }}" class="btn btn-primary btn-sm">
              Edit
          </a>

          <button type="button"
                  class="btn btn-outline btn-sm btn-warning"
                  onclick="document.getElementById('change-status-modal').showModal()">
              Change Status
          </button>
      </div>

    </div>


    <!-- ================= Career Summary ================= -->
    <div class="card bg-base-100 shadow-md border border-base-200 p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">

        <!-- Current Role Status -->
        <div>
          <p class="text-xs text-base-content/60 mb-1">Current Role Status</p>
          {% if job_fit %}
            {% if job_fit.score >= 85 %}
              <span class="badge badge-success">Ready</span>
            {% elif job_fit.score >= 70 %}
              <span class="badge badge-warning">Near Ready</span>
            {% else %}
              <span class="badge badge-error">Not Ready</span>
            {% endif %}
          {% else %}
            <span class="badge badge-ghost">—</span>
          {% endif %}
        </div>

        <!-- Next Role -->
        <div>
          <p class="text-xs text-base-content/60 mb-1">Next Role</p>
          {% if next_role %}
            <a href="{% url 'hr:job_detail' next_role.id %}"
               class="link link-hover font-semibold">
              {{ next_role.name }}
            </a>
          {% else %}
            <span class="text-sm opacity-60">—</span>
          {% endif %}
        </div>

        <!-- Promotion Status -->
        <div>
          <p class="text-xs text-base-content/60 mb-1">Promotion Status</p>
          {% if career_path %}
            {% if career_path.0.eligible %}
              <span class="badge badge-success">Eligible for Promotion</span>
            {% else %}
              <span class="badge badge-neutral">Not Eligible for Promotion</span>
            {% endif %}
          {% else %}
            <span class="badge badge-ghost">—</span>
          {% endif %}
        </div>

        <!-- Blocking Reason -->
        <div>
          <p class="text-xs text-base-content/60 mb-1">Blocking Reason</p>
          {% if career_path and not career_path.0.eligible %}
            {% if career_path.0.missing_skills %}
              <span class="text-error text-sm">
                Missing Skills
              </span>
            {% elif career_path.0.gap_skills %}
              <span class="text-warning text-sm">
                Skills Need Improvement
              </span>
            {% else %}
              <span class="text-sm opacity-60">—</span>
            {% endif %}
          {% else %}
            <span class="text-success text-sm">
              No blockers
            </span>
          {% endif %}
        </div>

      </div>
    </div>


    <!-- ===================================================== -->
    <!-- Tabs (DaisyUI – Radio Tabs, NO JS) -->
    <!-- ===================================================== -->
    <div class="tabs tabs-bordered">

    <!-- ================= Overview ================= -->
    <input type="radio" name="emp_tabs" class="tab" aria-label="Overview" checked />
    <div class="tab-content bg-base-100 p-6 rounded-box mt-4">

      <div class="space-y-8">

        <!-- ===================================================== -->
        <!-- Top Summary (Admin-friendly) -->
        <!-- ===================================================== -->
        <section>
          <div class="flex items-start justify-between gap-4 mb-4">
            <div>
              <h3 class="text-lg font-semibold">Overview</h3>
              <p class="text-xs text-base-content/60 mt-1">
                Quick summary for administrative decisions (role readiness, next step, and key profile details).
              </p>
            </div>

            {% if job_fit %}
              <div class="flex items-center gap-2">
                {% if job_fit.score >= 85 %}
                  <span class="badge badge-success">Ready</span>
                {% elif job_fit.score >= 70 %}
                  <span class="badge badge-warning">Near Ready</span>
                {% else %}
                  <span class="badge badge-error">Not Ready</span>
                {% endif %}
                <span class="text-sm font-semibold">{{ job_fit.score }}%</span>
              </div>
            {% endif %}
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- ================= General ================= -->
            <div class="card bg-base-200/40 border border-base-300 p-5">
              <h4 class="font-semibold text-base mb-3">
                General Information
              </h4>

              <ul class="space-y-3 text-sm">
                <li class="flex items-start justify-between gap-3">
                  <span class="text-base-content/60">Company</span>
                  <span class="font-medium text-right">{{ employee.company.name }}</span>
                </li>

                <li class="flex items-start justify-between gap-3">
                  <span class="text-base-content/60">Department</span>
                  <span class="font-medium text-right">
                    {{ employee.department.complete_name|default:"—" }}
                  </span>
                </li>

                <li class="flex items-start justify-between gap-3">
                  <span class="text-base-content/60">Job Title</span>
                  <span class="font-medium text-right">
                    {{ employee.job.name|default:"—" }}
                  </span>
                </li>

                <li class="flex items-start justify-between gap-3">
                  <span class="text-base-content/60">Manager</span>
                  <span class="font-medium text-right">
                    {{ employee.manager.name|default:"—" }}
                  </span>
                </li>
              </ul>
            </div>

            <!-- ================= Account ================= -->
            <div class="card bg-base-200/40 border border-base-300 p-5">
              <h4 class="font-semibold text-base mb-3">
                Account Details
              </h4>

              <ul class="space-y-3 text-sm">
                <li class="flex items-start justify-between gap-3">
                  <span class="text-base-content/60">User</span>
                  <span class="font-medium text-right truncate max-w-[70%]">
                    {{ employee.user.email|default:"—" }}
                  </span>
                </li>

                <li class="flex items-start justify-between gap-3">
                  <span class="text-base-content/60">Barcode</span>
                  <span class="font-mono text-right">
                    {{ employee.barcode|default:"—" }}
                  </span>
                </li>

                <li class="flex items-start justify-between gap-3">
                  <span class="text-base-content/60">PIN</span>
                  <span class="font-mono text-right">
                    {{ employee.pin|default:"—" }}
                  </span>
                </li>
              </ul>
            </div>

            <!-- ================= Classification ================= -->
            <div class="card bg-base-200/40 border border-base-300 p-5">
              <h4 class="font-semibold text-base mb-3">
                Classification
              </h4>

              {% if employee.categories.exists %}
                <div class="flex flex-wrap gap-2">
                  {% for cat in employee.categories.all %}
                    <span class="badge badge-outline text-xs">
                      {{ cat.name }}
                    </span>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-sm text-base-content/60">
                  No classifications assigned.
                </p>
              {% endif %}
            </div>

          </div>
        </section>

        <!-- ===================================================== -->
        <!-- Career Readiness (Primary Card) -->
        <!-- ===================================================== -->
        <section class="card bg-base-100 shadow-md border border-base-200 p-6">
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3 mb-4">
            <div>
              <h3 class="font-semibold text-lg">
                Career Readiness Overview
              </h3>
              <p class="text-xs text-base-content/60 mt-1">
                Readiness is based on current role skill requirements compared to the employee’s recorded skills.
              </p>
            </div>

            {% if job_fit %}
              {% if job_fit.score >= 85 %}
                <span class="badge badge-success">Ready</span>
              {% elif job_fit.score >= 70 %}
                <span class="badge badge-warning">Near Ready</span>
              {% else %}
                <span class="badge badge-error">Not Ready</span>
              {% endif %}
            {% endif %}
          </div>

          {% if job_fit %}

            <!-- Score -->
            <div class="mb-5">
              <div class="flex items-center justify-between text-sm mb-1">
                <span class="text-base-content/60">Readiness Score</span>
                <span class="font-semibold">{{ job_fit.score }}%</span>
              </div>

              <progress
                class="progress
                  {% if job_fit.score >= 85 %}
                    progress-success
                  {% elif job_fit.score >= 70 %}
                    progress-warning
                  {% else %}
                    progress-error
                  {% endif %}
                "
                value="{{ job_fit.score }}"
                max="100">
              </progress>
            </div>

            <!-- Explanation -->
            <div class="text-sm text-base-content/70">
              {% if job_fit.score >= 85 %}
                Employee fully meets the required skills for the current role.
              {% elif job_fit.score >= 70 %}
                Minor skill gaps identified. Targeted training is recommended.
              {% else %}
                Significant skill gaps detected. Development is required before progression.
              {% endif %}
            </div>

            <!-- Next eligible role -->
            {% if next_eligible_job %}
              <div class="mt-4 text-sm">
                <span class="text-base-content/60">Next eligible role:</span>
                <a href="{{ next_eligible_job.get_absolute_url }}"
                   class="link link-hover font-medium ml-1">
                  {{ next_eligible_job.name }}
                </a>
              </div>
            {% endif %}

            <!-- Training recommendations -->
            {% if training_recommendations_top %}
              <div class="mt-6">
                <div class="flex items-center justify-between gap-3 mb-3">
                  <h4 class="text-sm font-semibold">
                    Priority Training Recommendations
                  </h4>

                  <label for="emp_tabs"
                         class="link link-hover text-sm text-base-content/70"
                         onclick="document.querySelector('input[aria-label=&quot;Skills&quot;]').click()">
                    View full skill gap →
                  </label>
                </div>

                <ul class="space-y-3 text-sm">
                  {% for rec in training_recommendations_top %}
                    <li class="flex items-start gap-3">
                      <span class="mt-2 h-2 w-2 rounded-full
                        {% if rec.status == 'missing' %}
                          bg-error
                        {% else %}
                          bg-warning
                        {% endif %}
                      "></span>

                      <div class="min-w-0">
                        <div class="font-medium">
                          {{ rec.skill.name }}
                          <span class="text-base-content/50">
                            ({{ rec.status|capfirst }})
                          </span>
                        </div>

                        <div class="text-xs text-base-content/60 mt-1">
                          {% if rec.status == "missing" %}
                            Critical requirement for the next eligible role.
                          {% else %}
                            Improvement recommended for career progression.
                          {% endif %}
                        </div>
                      </div>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

          {% else %}
            <p class="text-sm text-base-content/60">
              Readiness data not available.
            </p>
          {% endif %}
        </section>

        <!-- ===================================================== -->
        <!-- Next Role – Skill Readiness (Secondary Card) -->
        <!-- ===================================================== -->
        {% if next_role %}
        <section class="card bg-base-200/30 border border-base-300 p-5">
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3 mb-3">
            <div>
              <h3 class="font-semibold text-lg">
                Next Role – Skill Readiness
              </h3>
              <p class="text-xs text-base-content/60 mt-1">
                Required skills for the next role compared against the employee’s current skill profile.
              </p>
            </div>

            <div class="text-sm">
              <span class="text-base-content/60">Target role:</span>
              <span class="font-medium ml-1">{{ next_role.name }}</span>
            </div>
          </div>

          {% if next_role_missing_skills or next_role_gap_skills %}

            {% if next_role_missing_skills %}
              <div class="mb-4">
                <p class="text-sm font-semibold text-error mb-2">
                  Missing Skills
                </p>
                <ul class="list-disc list-inside text-sm text-base-content/80 space-y-1">
                  {% for req in next_role_missing_skills %}
                    <li>
                      <span class="font-medium">{{ req.skill.name }}</span>
                      <span class="text-base-content/60">
                        ({{ req.min_level.name }})
                      </span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            {% if next_role_gap_skills %}
              <div>
                <p class="text-sm font-semibold text-warning mb-2">
                  Skills to Improve
                </p>
                <ul class="list-disc list-inside text-sm text-base-content/80 space-y-1">
                  {% for item in next_role_gap_skills %}
                    <li>
                      <span class="font-medium">{{ item.skill.name }}</span>
                      <span class="text-base-content/60">
                        — {{ item.current.name }} → {{ item.required.name }}
                      </span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

          {% else %}
            <p class="text-sm text-success">
              All required skills for the next role are met.
            </p>
          {% endif %}
        </section>
        {% endif %}

      </div>

    </div>


<!-- ================= Career Path ================= -->
<input type="radio" name="emp_tabs" class="tab" aria-label="Career Path" />
<div class="tab-content bg-base-100 p-6 rounded-box mt-4">

  <div class="space-y-6">

    <!-- ===================================================== -->
    <!-- Header -->
    <!-- ===================================================== -->
    <section>
      <h3 class="text-lg font-semibold">
        Career Path & Promotion Readiness
      </h3>
      <p class="text-sm text-base-content/60 mt-1 max-w-3xl">
        This section evaluates promotion eligibility based strictly on skill completeness
        for each potential next role. Scores are not used—only actual skill readiness.
      </p>
    </section>

    <!-- ===================================================== -->
    <!-- Career Path Table -->
    <!-- ===================================================== -->
    {% if career_path %}
    <section class="card bg-base-200/40 border border-base-300 p-5">

      <div class="overflow-x-auto mt-2">
        <table class="table table-zebra w-full text-sm">

          <thead>
            <tr>
              <th>Target Role</th>
              <th class="whitespace-nowrap">Promotion Status</th>
              <th class="whitespace-nowrap text-center">Missing Skills</th>
              <th class="whitespace-nowrap text-center">Skills to Improve</th>
              <th class="whitespace-nowrap">Decision</th>
            </tr>
          </thead>

          <tbody>

            {% for row in career_path %}
            <tr
              {% if row.eligible %}
                class="bg-success/10 border-l-4 border-success"
              {% endif %}
            >

              <!-- Target Role (Primary Column) -->
              <td class="font-medium">
                {% if row.job %}
                  <a href="{% url 'hr:job_detail' row.job.pk %}"
                     class="link link-hover font-semibold">
                    {{ row.job.name }}
                  </a>
                {% else %}
                  —
                {% endif %}
              </td>

              <!-- Promotion Status -->
              <td>
                {% if row.eligible %}
                  <span class="badge badge-success badge-sm">
                    Eligible for Promotion
                  </span>
                {% else %}
                  <span class="badge badge-neutral badge-sm">
                    Not Eligible
                  </span>
                {% endif %}
              </td>

              <!-- Missing Skills -->
              <td class="text-center">
                {% if row.missing_count > 0 %}
                  <span class="text-error font-semibold">
                    {{ row.missing_count }}
                  </span>
                {% else %}
                  <span class="text-success">—</span>
                {% endif %}
              </td>

              <!-- Skills to Improve -->
              <td class="text-center">
                {% if row.gap_count > 0 %}
                  <span class="text-warning font-semibold">
                    {{ row.gap_count }}
                  </span>
                {% else %}
                  <span class="text-success">—</span>
                {% endif %}
              </td>

              <!-- Decision (Human-readable) -->
              <td class="text-sm">
                {% if row.eligible %}
                  <span class="text-success font-medium">
                    Ready for promotion
                  </span>
                {% else %}
                  <span class="text-base-content/60">
                    Development required
                  </span>
                {% endif %}
              </td>

            </tr>
            {% endfor %}

          </tbody>

        </table>
      </div>

      <!-- ===================================================== -->
      <!-- Footer Note -->
      <!-- ===================================================== -->
      <div class="text-xs text-base-content/50 mt-3 max-w-3xl">
        Promotion eligibility is granted only when all required skills are met.
        Any missing or below-level skill automatically blocks promotion.
      </div>

    </section>

    {% else %}
      <div class="alert alert-info">
        No career path is defined for the employee’s current role.
      </div>
    {% endif %}

  </div>

</div>


<!-- ================= Skills ================= -->
<input type="radio" name="emp_tabs" class="tab" aria-label="Skills" />
<div class="tab-content bg-base-100 p-6 rounded-box mt-4 space-y-8">

  <!-- ===================================================== -->
  <!-- Current Role – Employee Skills -->
  <!-- ===================================================== -->
  <section class="card bg-base-200/40 border border-base-300 p-5">

    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div>
        <h3 class="text-lg font-semibold">
          Current Role – Employee Skills
        </h3>
        <p class="text-xs text-base-content/60 mt-1">
          The employee’s recorded skills and levels for the current role.
        </p>
      </div>

      <a href="{% url 'skills:employeeskill_create' %}?employee={{ employee.id }}"
         class="btn btn-sm btn-primary">
        + Add Skill
      </a>
    </div>

    <div class="overflow-x-auto mt-4">
      <table class="table table-zebra w-full text-sm">
        <thead>
          <tr>
            <th class="whitespace-nowrap">Skill Type</th>
            <th>Skill</th>
            <th class="whitespace-nowrap">Level</th>
          </tr>
        </thead>
        <tbody>
          {% for es in employee_skills %}
          <tr>
            <td class="font-medium">{{ es.skill_type.name }}</td>
            <td>{{ es.skill.name }}</td>
            <td class="text-base-content/70">
              {{ es.skill_level.name|default:"—" }}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="3" class="text-center text-base-content/60">
              No skills assigned to this employee.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </section>

  <!-- ===================================================== -->
  <!-- Current Role – Skill Gap Analysis -->
  <!-- ===================================================== -->
  {% if skill_gap %}
  <section class="card bg-base-200/30 border border-base-300 p-5">

    <div class="flex flex-col gap-1 mb-4">
      <h4 class="font-semibold text-md text-error">
        Current Role – Skill Gap Analysis
      </h4>
      <p class="text-xs text-base-content/60">
        Comparison between required skills for the current role and the employee’s actual skill levels.
      </p>
    </div>

    <div class="overflow-x-auto mt-4">
      <table class="table table-zebra w-full text-sm">
        <thead>
          <tr>
            <th>Required Skill</th>
            <th class="whitespace-nowrap">Required Level</th>
            <th class="whitespace-nowrap">Employee Level</th>
            <th class="whitespace-nowrap">Status</th>
          </tr>
        </thead>
        <tbody>

          {% for row in skill_gap %}
          <tr>

            <!-- Primary column: Skill -->
            <td class="font-medium">
              {{ row.required_skill.name }}
            </td>

            <!-- Secondary: Required level -->
            <td class="text-base-content/70">
              {{ row.required_level.name }}
              <span class="text-xs text-base-content/50">
                ({{ row.required_level.level_progress }}%)
              </span>
            </td>

            <!-- Secondary: Employee level -->
            <td class="text-base-content/70">
              {% if row.employee_level %}
                {{ row.employee_level.name }}
                <span class="text-xs text-base-content/50">
                  ({{ row.employee_level.level_progress }}%)
                </span>
              {% else %}
                —
              {% endif %}
            </td>

            <!-- Status: unified badge -->
            <td>
              <span class="badge badge-sm
                {% if row.status == 'ok' %}
                  badge-success
                {% elif row.status == 'gap' %}
                  badge-warning
                {% else %}
                  badge-error
                {% endif %}
              ">
                {{ row.status|upper }}
              </span>
            </td>

          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center text-base-content/60">
              No skill requirements defined for this job.
            </td>
          </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>

    <div class="text-xs text-base-content/50 mt-3">
      Status meanings: OK = meets requirement, GAP = below required level, MISSING = skill not recorded.
    </div>

  </section>
  {% endif %}

</div>


<!-- ================= Assets ================= -->
<input type="radio" name="emp_tabs" class="tab" aria-label="Assets" />
<div class="tab-content bg-base-100 p-6 rounded-box mt-4 space-y-8">

  <!-- ===================================================== -->
  <!-- Header -->
  <!-- ===================================================== -->
  <section>
    <h3 class="text-lg font-semibold">
      Employee Assets & Equipment
    </h3>
    <p class="text-sm text-base-content/60 mt-1 max-w-3xl">
      Track all assets currently assigned to the employee, including assignment history
      and asset holding duration. Each asset can be assigned to only one employee at a time.
    </p>
  </section>

  <!-- ===================================================== -->
  <!-- Current Assets -->
  <!-- ===================================================== -->
  <section class="card bg-base-200/40 border border-base-300 p-5">

    <div class="flex items-center justify-between mb-4">
      <h4 class="font-semibold text-md">
        Current Assets
      </h4>

      <a href="{% url 'assets:asset_list' %}?assign_to={{ employee.id }}"
         class="btn btn-sm btn-primary">
        + Assign Asset
      </a>
    </div>

    {% if current_asset_assignments %}
      <div class="overflow-x-auto mt-3">
        <table class="table table-zebra w-full text-sm">

          <thead>
            <tr>
              <th>Asset</th>
              <th class="whitespace-nowrap">Assigned From</th>
              <th class="whitespace-nowrap">Holding Duration</th>
              <th>Status</th>
              <th class="text-right whitespace-nowrap">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for asg in current_asset_assignments %}
            <tr>

              <!-- Asset (Primary Column) -->
              <td class="font-medium">
                <a href="{% url 'assets:asset_detail' asg.asset.id %}"
                   class="link link-hover font-semibold">
                  {{ asg.asset.code }} — {{ asg.asset.name }}
                </a>
              </td>

              <!-- Assigned From -->
              <td>
                {{ asg.date_from|date:"Y-m-d" }}
              </td>

              <!-- Holding Duration -->
              <td>
                {{ asg.date_from|timesince }} ago
              </td>

              <!-- Status -->
              <td>
                <span class="badge badge-success badge-sm">
                  Active
                </span>
              </td>

              <!-- Actions -->
              <td class="text-right">
                <a href="{% url 'assets:asset_unassign' asg.asset.id %}"
                   class="btn btn-xs btn-warning"
                   onclick="return confirm('Unassign this asset from the employee?');">
                  Unassign
                </a>
              </td>

            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    {% else %}
      <p class="text-sm text-base-content/60 mt-2">
        No assets are currently assigned to this employee.
      </p>
    {% endif %}

  </section>

  <!-- ===================================================== -->
  <!-- Asset Assignment History -->
  <!-- ===================================================== -->
  <section class="card bg-base-200/30 border border-base-300 p-5">

    <h4 class="font-semibold text-md mb-1">
      Asset Assignment History
    </h4>

    <p class="text-xs text-base-content/60 mb-4">
      Historical record of previously assigned assets, including return dates and usage duration.
    </p>

    {% if employee_assets_history %}
      <div class="overflow-x-auto mt-3">
        <table class="table table-zebra w-full text-sm">

          <thead>
            <tr>
              <th>Asset</th>
              <th class="whitespace-nowrap">Assigned From</th>
              <th class="whitespace-nowrap">Returned On</th>
              <th class="whitespace-nowrap">Holding Duration</th>
              <th>Status</th>
            </tr>
          </thead>

          <tbody>
            {% for asg in employee_assets_history %}
              {% if asg.date_to %}
              <tr>

                <!-- Asset -->
                <td class="font-medium">
                  <a href="{% url 'assets:asset_detail' asg.asset.id %}"
                     class="link link-hover font-semibold">
                    {{ asg.asset.code }} — {{ asg.asset.name }}
                  </a>
                </td>

                <!-- Assigned From -->
                <td>
                  {{ asg.date_from|date:"Y-m-d" }}
                </td>

                <!-- Returned On -->
                <td>
                  {{ asg.date_to|date:"Y-m-d" }}
                </td>

                <!-- Holding Duration -->
                <td>
                  {{ asg.date_from|timesince:asg.date_to }}
                </td>

                <!-- Status -->
                <td>
                  <span class="badge badge-ghost badge-sm">
                    Returned
                  </span>
                </td>

              </tr>
              {% endif %}
            {% endfor %}
          </tbody>

        </table>
      </div>
    {% else %}
      <p class="text-sm text-base-content/60 mt-2">
        No previous asset assignments found.
      </p>
    {% endif %}

  </section>

</div>



<!-- ================= Organization ================= -->
<input type="radio" name="emp_tabs" class="tab" aria-label="Organization" />
<div class="tab-content bg-base-100 p-6 rounded-box mt-4 space-y-8">

  <!-- ===================================================== -->
  <!-- Header -->
  <!-- ===================================================== -->
  <section>
    <h3 class="text-lg font-semibold">
      Organizational Structure
    </h3>
    <p class="text-sm text-base-content/60 mt-1 max-w-3xl">
      View the employee’s position within the organizational hierarchy,
      including reporting lines and direct subordinates.
    </p>
  </section>

  <!-- ===================================================== -->
  <!-- Organization Grid -->
  <!-- ===================================================== -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- ================= Management Chain ================= -->
    <div class="card bg-base-200/40 border border-base-300 p-5">

      <h4 class="font-semibold text-md mb-2">
        Management Chain
      </h4>

      <p class="text-xs text-base-content/60 mb-4">
        Hierarchical reporting line from the employee up to top management.
      </p>

      {% if manager_chain %}
        <ul class="space-y-2 text-sm">
          {% for m in manager_chain %}
            <li class="flex items-center gap-2">
              <span class="h-1.5 w-1.5 rounded-full bg-base-content/40"></span>
              <span class="font-medium">{{ m.name }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-base-content/60">
          This employee does not report to any manager.
        </p>
      {% endif %}

    </div>

    <!-- ================= Subordinates ================= -->
    <div class="card bg-base-200/40 border border-base-300 p-5">

      <h4 class="font-semibold text-md mb-2">
        Direct Subordinates
      </h4>

      <p class="text-xs text-base-content/60 mb-4">
        Employees who directly report to this employee.
      </p>

      {% if subordinates %}
        <ul class="space-y-2 text-sm">
          {% for s in subordinates %}
            <li class="flex items-center gap-2">
              <span class="h-1.5 w-1.5 rounded-full bg-base-content/40"></span>
              <span class="font-medium">{{ s.name }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-base-content/60">
          This employee has no direct subordinates.
        </p>
      {% endif %}

    </div>

  </section>

</div>


<!-- ================= Status History ================= -->
<input type="radio" name="emp_tabs" class="tab" aria-label="Status History" />
<div class="tab-content bg-base-100 p-6 rounded-box mt-4 space-y-6">

  <!-- ===================================================== -->
  <!-- Header -->
  <!-- ===================================================== -->
  <section>
    <h3 class="text-lg font-semibold">
      Employee Status History
    </h3>
    <p class="text-sm text-base-content/60 mt-1 max-w-3xl">
      Chronological record of all status changes applied to the employee,
      including reasons, notes, and audit information.
    </p>
  </section>

  <!-- ===================================================== -->
  <!-- Status History Table -->
  <!-- ===================================================== -->
  {% if status_history %}
    <section class="card bg-base-200/40 border border-base-300 p-5">

      <div class="overflow-x-auto">
        <table class="table table-zebra w-full text-sm">
          <thead>
            <tr>
              <th>Status</th>
              <th>Reason</th>
              <th>Note</th>
              <th>Changed By</th>
              <th>Changed At</th>
            </tr>
          </thead>
          <tbody>

            {% for h in status_history %}
            <tr>

              <!-- Status -->
              <td>
                <span class="badge badge-sm
                  {% if h.status.is_active_flag %}
                    badge-success
                  {% elif h.status.code == 'suspended' %}
                    badge-warning
                  {% else %}
                    badge-error
                  {% endif %}
                ">
                  {{ h.status.name }}
                </span>
              </td>

              <!-- Reason -->
              <td class="font-medium">
                {{ h.reason|default:"—" }}
              </td>

              <!-- Note -->
              <td class="max-w-md">
                {% if h.note %}
                  <span class="truncate block" title="{{ h.note }}">
                    {{ h.note }}
                  </span>
                {% else %}
                  <span class="text-base-content/50">—</span>
                {% endif %}
              </td>

              <!-- Changed By -->
              <td>
                {{ h.changed_by|default:"—" }}
              </td>

              <!-- Changed At -->
              <td class="whitespace-nowrap text-base-content/80">
                {{ h.changed_at|date:"Y-m-d H:i" }}
              </td>

            </tr>
            {% endfor %}

          </tbody>
        </table>
      </div>

    </section>

  {% else %}
    <!-- ===================================================== -->
    <!-- Empty State -->
    <!-- ===================================================== -->
    <div class="alert alert-info">
      <span class="font-medium">
        No status history available.
      </span>
      <span class="text-sm opacity-70 ml-1">
        This employee has not undergone any status changes yet.
      </span>
    </div>
  {% endif %}

</div>


<!-- ================= Personal Info ================= -->
<input type="radio" name="emp_tabs" class="tab" aria-label="Personal Info" />
<div class="tab-content bg-base-100 p-6 rounded-box mt-4 space-y-8">

  <!-- ===================================================== -->
  <!-- Header -->
  <!-- ===================================================== -->
  <section>
    <h3 class="text-lg font-semibold">
      Personal Information
    </h3>
    <p class="text-sm text-base-content/60 mt-1 max-w-3xl">
      Confidential personal, identification, and emergency contact details
      related to the employee.
    </p>
  </section>

  <!-- ===================================================== -->
  <!-- Content Grid -->
  <!-- ===================================================== -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- ===================================================== -->
    <!-- Personal Details -->
    <!-- ===================================================== -->
    <section class="card bg-base-200/40 border border-base-300 p-5">
      <h4 class="font-semibold text-md mb-4">
        Personal Details
      </h4>

      <ul class="space-y-3 text-sm">

        <li class="flex justify-between">
          <span class="text-base-content/60">Private Phone</span>
          <span class="font-medium">
            {{ employee.private_phone|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Private Email</span>
          <span class="font-medium truncate max-w-[60%]">
            {{ employee.private_email|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Birthday</span>
          <span class="font-medium">
            {{ employee.birthday|date:"Y-m-d"|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Place of Birth</span>
          <span class="font-medium">
            {{ employee.place_of_birth|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Gender</span>
          <span class="font-medium">
            {{ employee.get_gender_display|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Marital Status</span>
          <span class="font-medium">
            {{ employee.get_marital_status_display|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Children</span>
          <span class="font-medium">
            {{ employee.children }}
          </span>
        </li>

      </ul>
    </section>

    <!-- ===================================================== -->
    <!-- Identification -->
    <!-- ===================================================== -->
    <section class="card bg-base-200/40 border border-base-300 p-5">
      <h4 class="font-semibold text-md mb-4">
        Identification
      </h4>

      <ul class="space-y-3 text-sm">

        <li class="flex justify-between">
          <span class="text-base-content/60">National ID</span>
          <span class="font-mono">
            {{ employee.identification_id|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Passport ID</span>
          <span class="font-mono">
            {{ employee.passport_id|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Bank Account</span>
          <span class="font-mono truncate max-w-[60%]">
            {{ employee.bank_account|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Car</span>
          <span class="font-medium">
            {{ employee.car|default:"—" }}
          </span>
        </li>

      </ul>
    </section>

    <!-- ===================================================== -->
    <!-- Emergency Contact -->
    <!-- ===================================================== -->
    <section class="card bg-base-200/40 border border-base-300 p-5 md:col-span-2">
      <h4 class="font-semibold text-md mb-4">
        Emergency Contact
      </h4>

      <ul class="space-y-3 text-sm max-w-lg">

        <li class="flex justify-between">
          <span class="text-base-content/60">Contact Name</span>
          <span class="font-medium">
            {{ employee.emergency_contact|default:"—" }}
          </span>
        </li>

        <li class="flex justify-between">
          <span class="text-base-content/60">Phone</span>
          <span class="font-medium">
            {{ employee.emergency_phone|default:"—" }}
          </span>
        </li>

      </ul>
    </section>

  </div>

</div>



<!-- ================= Education ================= -->
<input type="radio" name="emp_tabs" class="tab" aria-label="Education" />
<div class="tab-content bg-base-100 p-6 rounded-box mt-4 space-y-6">

  <!-- ===================================================== -->
  <!-- Header -->
  <!-- ===================================================== -->
  <section class="flex items-start justify-between gap-4">
    <div>
      <h3 class="text-lg font-semibold">
        Education & Qualifications
      </h3>
      <p class="text-sm text-base-content/60 mt-1 max-w-3xl">
        Academic background and professional qualifications recorded for the employee.
      </p>
    </div>

    <button type="button"
            class="btn btn-sm btn-primary"
            onclick="document.getElementById('add-education-modal').showModal()">
      + Add Education
    </button>
  </section>

  <!-- ===================================================== -->
  <!-- Education Records -->
  <!-- ===================================================== -->
  {% if education_records %}
    <section class="card bg-base-200/40 border border-base-300 p-5">

      <div class="overflow-x-auto">
        <table class="table table-zebra w-full text-sm">
          <thead>
            <tr>
              <th>Certificate</th>
              <th>Field of Study</th>
              <th>Institution</th>
              <th>Period</th>
              <th>Notes</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>

            {% for ed in education_records %}
            <tr>

              <!-- Certificate -->
              <td class="font-medium">
                {{ ed.certificate|default:"—" }}
              </td>

              <!-- Field of Study -->
              <td>
                {{ ed.field_of_study|default:"—" }}
              </td>

              <!-- Institution -->
              <td>
                {{ ed.institution|default:"—" }}
              </td>

              <!-- Period -->
              <td class="whitespace-nowrap">
                {{ ed.start_year }}
                {% if ed.end_year %}
                  – {{ ed.end_year }}
                {% else %}
                  <span class="text-base-content/50">– Present</span>
                {% endif %}
              </td>

              <!-- Notes -->
              <td class="max-w-md">
                {% if ed.notes %}
                  <span class="truncate block" title="{{ ed.notes }}">
                    {{ ed.notes }}
                  </span>
                {% else %}
                  <span class="text-base-content/50">—</span>
                {% endif %}
              </td>

              <!-- Actions -->
              <td class="text-right">
                <div class="flex justify-end gap-1">

                  <!-- Edit -->
                  <button type="button"
                          class="btn btn-ghost btn-xs"
                          onclick="
                            document.getElementById('edit-education-form').action =
                            '{% url 'hr:education_edit' ed.id %}';

                            document.getElementById('edit_certificate').value = '{{ ed.certificate|escapejs }}';
                            document.getElementById('edit_field').value = '{{ ed.field_of_study|escapejs }}';
                            document.getElementById('edit_institution').value = '{{ ed.institution|escapejs }}';
                            document.getElementById('edit_start_year').value = '{{ ed.start_year }}';
                            document.getElementById('edit_end_year').value = '{{ ed.end_year|default_if_none:'' }}';
                            document.getElementById('edit_notes').value = '{{ ed.notes|escapejs }}';

                            document.getElementById('edit-education-modal').showModal();
                          ">
                    Edit
                  </button>

                  <!-- Delete -->
                  <a href="{% url 'hr:education_delete' ed.id %}"
                     class="btn btn-ghost btn-xs text-error"
                     onclick="return confirm('Are you sure you want to delete this education record?');">
                    Delete
                  </a>

                </div>
              </td>

            </tr>
            {% endfor %}

          </tbody>
        </table>
      </div>

    </section>

  {% else %}
    <!-- ===================================================== -->
    <!-- Empty State -->
    <!-- ===================================================== -->
    <div class="alert alert-info">
      <span class="font-medium">
        No education records added yet.
      </span>
      <span class="text-sm opacity-70 ml-1">
        Use “Add Education” to record academic or professional qualifications.
      </span>
    </div>
  {% endif %}

</div>


    </div>

</div>


<!-- ===================================================== -->
<!-- Change Status Modal (DaisyUI v4 - dialog based) -->
<!-- ===================================================== -->

<dialog id="change-status-modal" class="modal">
    <div class="modal-box">

        <form method="post"
              action="{% url 'hr:employee_change_status' employee.id %}"
              class="space-y-4">
            {% csrf_token %}

            <h3 class="font-bold text-lg mb-4">
                Change Employee Status
            </h3>

            <!-- Status -->
            <div>
                <label class="label">
                    <span class="label-text font-medium">New Status</span>
                </label>
                <select name="status"
                        class="select select-bordered w-full"
                        required>
                    <option value="">Select status</option>
                    {% for st in employee_statuses %}
                        <option value="{{ st.id }}"
                            {% if st.id == employee.current_status_id %}
                                disabled
                            {% endif %}
                        >
                            {{ st.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Reason -->
            <div>
                <label class="label">
                    <span class="label-text font-medium">Reason</span>
                </label>
                <input type="text"
                       name="reason"
                       class="input input-bordered w-full"
                       required />
            </div>

            <!-- Note -->
            <div>
                <label class="label">
                    <span class="label-text font-medium">Note (optional)</span>
                </label>
                <textarea name="note"
                          class="textarea textarea-bordered w-full"
                          rows="3"></textarea>
            </div>

            <!-- Actions -->
            <div class="modal-action">
                <button type="button"
                        class="btn btn-ghost"
                        onclick="document.getElementById('change-status-modal').close()">
                    Cancel
                </button>

                <button type="submit" class="btn btn-warning">
                    Change Status
                </button>
            </div>
        </form>

    </div>
</dialog>


<!-- ===================================================== -->
<!-- Add Education Modal -->
<!-- ===================================================== -->
<dialog id="add-education-modal" class="modal">
    <div class="modal-box">
        <form method="post"
              action="{% url 'hr:employee_education_add' employee.id %}"
              class="space-y-4">
            {% csrf_token %}

            <h3 class="font-bold text-lg">Add Education</h3>

            <input name="certificate" class="input input-bordered w-full" placeholder="Certificate">
            <input name="field_of_study" class="input input-bordered w-full" placeholder="Field of Study">
            <input name="institution" class="input input-bordered w-full" placeholder="Institution">

            <div class="grid grid-cols-2 gap-4">
                <input name="start_year" class="input input-bordered w-full" placeholder="Start Year">
                <input name="end_year" class="input input-bordered w-full" placeholder="End Year">
            </div>

            <textarea name="notes" class="textarea textarea-bordered w-full" rows="3"
                      placeholder="Notes"></textarea>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost"
                        onclick="document.getElementById('add-education-modal').close()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</dialog>
<!-- ===================================================== -->
<!-- Edit Education Modal -->
<!-- ===================================================== -->
<dialog id="edit-education-modal" class="modal">
    <div class="modal-box">
        <form method="post" id="edit-education-form" class="space-y-4">
            {% csrf_token %}

            <h3 class="font-bold text-lg">Edit Education</h3>

            <input id="edit_certificate" name="certificate" class="input input-bordered w-full">
            <input id="edit_field" name="field_of_study" class="input input-bordered w-full">
            <input id="edit_institution" name="institution" class="input input-bordered w-full">

            <div class="grid grid-cols-2 gap-4">
                <input id="edit_start_year" name="start_year" class="input input-bordered w-full">
                <input id="edit_end_year" name="end_year" class="input input-bordered w-full">
            </div>

            <textarea id="edit_notes" name="notes"
                      class="textarea textarea-bordered w-full"
                      rows="3"></textarea>

            <div class="modal-action">
                <button type="button" class="btn btn-ghost"
                        onclick="document.getElementById('edit-education-modal').close()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</dialog>


{% endblock %}
